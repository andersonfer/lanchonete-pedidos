name: CD

on:
  push:
    branches: [main]

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY: lanchonete-pedidos
  EKS_CLUSTER_NAME: lanchonete-cluster
  SERVICE_NAME: pedidos
  K8S_NAMESPACE: default

jobs:
  deploy:
    name: Build e Deploy
    runs-on: ubuntu-latest

    steps:
    - name: Checkout código
      uses: actions/checkout@v4

    - name: Setup Java 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven

    - name: Build aplicação
      run: mvn clean package -DskipTests -q

    - name: Configurar AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Login no Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    - name: Build e Push Docker
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        IMAGE_URI=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
        IMAGE_LATEST=$ECR_REGISTRY/$ECR_REPOSITORY:latest

        docker build -t $IMAGE_URI -t $IMAGE_LATEST .
        docker push $IMAGE_URI
        docker push $IMAGE_LATEST

        echo "Imagens publicadas:"
        echo "  - $IMAGE_URI"
        echo "  - $IMAGE_LATEST"

    - name: Configurar kubectl
      run: |
        aws eks update-kubeconfig \
          --region ${{ env.AWS_REGION }} \
          --name ${{ env.EKS_CLUSTER_NAME }}

    - name: Deploy no EKS
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        kubectl apply -f k8s/configmap.yaml
        kubectl apply -f k8s/service.yaml
        sed "s|{{ECR_PEDIDOS}}|$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG|g" \
          k8s/deployment.yaml | kubectl apply -f -
        # Ingress removido - usando Service LoadBalancer (ALB Controller nao instalado)

    - name: Aguardar deployment
      run: |
        kubectl rollout status deployment/pedidos-deployment \
          -n ${{ env.K8S_NAMESPACE }} \
          --timeout=5m

    - name: Smoke Tests
      run: |
        echo "Aguardando pods ficarem prontos..."
        kubectl wait --for=condition=ready pod \
          -l app=pedidos \
          -n ${{ env.K8S_NAMESPACE }} \
          --timeout=300s

        POD_NAME=$(kubectl get pods -l app=pedidos -n ${{ env.K8S_NAMESPACE }} \
          -o jsonpath='{.items[0].metadata.name}')

        echo "Testando health endpoints no pod $POD_NAME..."

        kubectl exec $POD_NAME -n ${{ env.K8S_NAMESPACE }} -- \
          curl -sf http://localhost:8080/actuator/health || exit 1
        echo "Health check OK"

        kubectl exec $POD_NAME -n ${{ env.K8S_NAMESPACE }} -- \
          curl -sf http://localhost:8080/actuator/health/readiness || exit 1
        echo "Readiness OK"

        kubectl exec $POD_NAME -n ${{ env.K8S_NAMESPACE }} -- \
          curl -sf http://localhost:8080/actuator/health/liveness || exit 1
        echo "Liveness OK"

    - name: Verificar LoadBalancer
      if: always()
      run: |
        echo "Obtendo URL do LoadBalancer..."
        LB_URL=$(kubectl get svc pedidos-service -n ${{ env.K8S_NAMESPACE }} \
          -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' 2>/dev/null || echo "")

        if [ -n "$LB_URL" ]; then
          echo "LoadBalancer URL: http://$LB_URL"
          echo "LB_URL=$LB_URL" >> $GITHUB_ENV
          sleep 10
          curl -sf "http://$LB_URL/actuator/health" && echo "LoadBalancer respondendo!" || \
            echo "LoadBalancer ainda inicializando (normal em primeiro deploy)"
        else
          echo "LoadBalancer ainda nao provisionado"
        fi

    - name: Resumo do Deploy
      if: always()
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        echo "## Deploy Pedidos - Resumo" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Imagens:**" >> $GITHUB_STEP_SUMMARY
        echo "- \`$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG\`" >> $GITHUB_STEP_SUMMARY
        echo "- \`$ECR_REGISTRY/$ECR_REPOSITORY:latest\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Kubernetes:**" >> $GITHUB_STEP_SUMMARY
        echo "- Cluster: \`$EKS_CLUSTER_NAME\`" >> $GITHUB_STEP_SUMMARY
        echo "- Namespace: \`$K8S_NAMESPACE\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        LB_HOSTNAME=$(kubectl get svc pedidos-service -n $K8S_NAMESPACE \
          -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' 2>/dev/null || echo "Nao disponivel")
        echo "**LoadBalancer:** \`$LB_HOSTNAME\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Status dos Pods:**" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        kubectl get pods -l app=pedidos -n $K8S_NAMESPACE >> $GITHUB_STEP_SUMMARY || true
        echo '```' >> $GITHUB_STEP_SUMMARY
